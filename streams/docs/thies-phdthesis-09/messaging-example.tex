\begin{figure*}[t]
\vspace{-12pt}
\begin{minipage}[b]{150pt}
\psfig{figure=messaging/fir-orig.eps,scale=0.45}
\end{minipage}
\begin{minipage}[b]{300pt}
\psfig{figure=messaging/fir-struct.eps,scale=0.45}~~~~~
\psfig{figure=messaging/fir-messaging.eps,scale=0.45}
\end{minipage}

\begin{minipage}{150pt}
  \caption{\protect\small FIR code.
    \protect\label{fig:fir-orig-code}}
~\\
\end{minipage}~~
\begin{minipage}{153pt}
  \caption{\protect\small FIR code with manual event handling.  Modified lines are marked with an asterisk.
    \protect\label{fig:fir-manual-code}}
\end{minipage}~~~~~
\begin{minipage}{145pt}
  \caption{\protect\small FIR code with teleport messaging.  Modified lines are marked with an asterisk.
    \protect\label{fig:fir-message-code}}
\end{minipage} \vspace{2\baselineskip}

\begin{minipage}[t]{0.74in}
\begin{center}
\psfig{figure=messaging/fir1.eps,width=0.629in}
\end{center}
\end{minipage}
\hspace{0.15in}
\begin{minipage}[t]{3.04in}
\begin{center}
\psfig{figure=messaging/fir2.eps,width=3.04in}
\end{center}
\end{minipage}
\hspace{0.11in}
\begin{minipage}[t]{2.95in}
\begin{center}
\psfig{figure=messaging/fir3.eps,width=2.915in}
\end{center}
\end{minipage}

\begin{minipage}[t]{0.74in}
\mbox{~}
\caption{\protect\small FIR stream graph.\protect\label{fig:fir-orig-diagram}}
\end{minipage}
\hspace{0.2in}
\begin{minipage}[t]{2.9in}
\mbox{~}\hspace{0.045in}{\bf (a)}
~\hspace{0.368in}{\bf (b)}
~\hspace{0.345in}{\bf (c)}
~\hspace{0.345in}{\bf (d)}
~\hspace{0.345in}{\bf (e)}
\caption{\protect\small Execution snapshots illustrating manual
  embedding of control messages in FIR.  Channels are annotated with
  data items present on one possible execution; items are numbered in
  order of production.  {\bf (a)} Source initiates change of weights,
  {\bf (b)} weights are attached to data item \#5 and embedded in
  stream, {\bf (c)-(e)}, actors check each input item, adjusting their
  own weight when they find a tagged
  item.\protect\label{fig:fir-manual-diagram}}
\end{minipage}
\hspace{0.25in}
\begin{minipage}[t]{2.85in}
\mbox{~}\hspace{0.065in}{\bf (a)}
~\hspace{0.325in}{\bf (b)}
~\hspace{0.325in}{\bf (c)}
~\hspace{0.325in}{\bf (d)}
~\hspace{0.325in}{\bf (e)}
\caption{\protect\small Execution snapshots illustrating teleport messaging in FIR.
Channels are annotated with data items present on one possible
execution; items are numbered in order of production.  {\bf (a)}
Source calls a message handler, passing new weights as argument, {\bf
(b)} message boundary is maintained by compiler, {\bf (c)-(e)},
message handler is automatically invoked in actors immediately before
the arrival of affected
items. \protect\label{fig:fir-message-diagram}}
\end{minipage}

\end{figure*}


%% \begin{figure*}
%% \begin{minipage}{2in}
%% {\footnotesize
%% \begin{verbatim}
%%  1   struct Packet {
%%  2     int sum;
%%  3     int val;
%%  4   }
%%  5
%%  6   void->void pipeline FIR {
%%  7     int N = 128;
%%  8
%%  9     add Source(N);
%% 10     for (int i=0; i<N; i++)
%% 11       add Multiply(i);
%% 12     add Printer();
%% 13   }
%% 14
%% 15   void->float filter Source(int N) {
%% 16     work push 1 {
%% 17       Packet p;
%% 18       p.sum = 0;
%% 19       p.val = readNewData();
%% 20       push(p);
%% 21     }
%% 22   }
%% 23
%% 24   Packet->Packet filter Multiply(int i) {
%% 25     float W;
%% 26     Packet last;
%% 27
%% 28     work pop 1 push 1 {
%% 29       Packet in = pop();
%% 30       last.sum = in.sum + last.val * W;
%% 31       push(last);
%% 32       last = in;
%% 33     }
%% 34   } 
%% 35
%% 36   Packet->void filter Printer {
%% 37     work pop 1 { print(pop().sum); }
%% 38   }
%% \end{verbatim}}
%% \end{minipage}
%% %
%% %
%% \begin{minipage}{2in}
%% {\footnotesize
%% \begin{verbatim}
%%  1   struct Packet<N> {
%%  2     boolean newWeights;
%%  3     float[N] weights;
%%  4     int sum;
%%  5     int val;
%%  6   }
%%  7
%%  8   void->void pipeline FIR {
%%  9     int N = 128;
%% 10
%% 11     add Source(N);
%% 12     for (int i=0; i<N; i++)
%% 13       add Multiply(i, N);
%% 14     add Printer();
%% 15   }
%% 16
%% 17   void->Packet<N> filter Source(int N) {
%% 18     work push 1 {
%% 19       Packet p;
%% 20       p.sum = 0;
%% 21       p.val = readNewData();
%% 22
%% 23       if (newConditions()) {
%% 24         p.newWeights = true;
%% 25         p.weights = calcWeights();
%% 26       } else {
%% 27         p.newWeights = false;
%% 28       }
%% 29
%% 30       push(p);
%% 31     }
%% 32   }
%% 33
%% 34   Packet<N>-> 
%% 35   Packet<N> filter Multiply(int i, int N) {
%% 36     float W;
%% 37     Packet<N> last;
%% 38
%% 39     work pop 1 push 1 {
%% 40       Packet<N> in = pop();
%% 41       if (p.newWeights) {
%% 42         W = in.weights[i];
%% 43       }
%% 44       last.sum = in.sum + last.val * W;
%% 45       push(last);
%% 46       last = in;
%% 47     }
%% 48   }
%% 49
%% 50   Packet<N>->void filter Printer {
%% 51     work pop 1 {
%% 52       print(pop().sum);
%% 53     }
%% 54   }  
%% \end{verbatim}}
%% \end{minipage}
%% %
%% %
%% \begin{minipage}{2in}
%% {\footnotesize
%% \begin{verbatim}
%%  1   struct Packet {
%%  2     int sum;
%%  3     int val;
%%  4   }
%%  5   
%%  6   void->void pipeline FIR {
%%  7     int N = 128;
%%  8     portal<Multiply> teleport;
%%  9   
%% 10     add Source(N, teleport);
%% 11     for (int i=0; i<N; i++)
%% 12       add Multiply(i, N) to teleport;
%% 13     add Printer();
%% 14   }
%% 15   
%% 16   void->Packet filter
%% 17   Source(int N, portal<Multiply> teleport) {
%% 18     work push 1 {
%% 19       Packet p;
%% 20       p.sum = 0;
%% 21       p.val = readNewData();
%% 22       push(p);
%% 23   
%% 24       if (newConditions())
%% 25         teleport.setWeights(calcWeights());
%% 26     }
%% 27   }
%% 28   
%% 29   Packet->Packet filter Multiply(int i, int N) {
%% 30     float W;
%% 31     Packet last;
%% 32   
%% 33     work pop 1 push 1 {
%% 34       Packet in = pop();
%% 35       last.sum = in.sum + last.val * W;
%% 36       push(last);
%% 37       last = in;
%% 38     }
%% 39   
%% 40     handler setWeights(float[N] weights) {
%% 41       W = weights[i]
%% 42     }
%% 43   }
%% 44   
%% 45   Packet->void filter Printer {
%% 46     work pop 1 {
%% 47       print(pop().sum);
%% 48     }
%% 49   }
%% \end{verbatim}}
%% \end{minipage}
%% \end{figure*}
\clearpage
